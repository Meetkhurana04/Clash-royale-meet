<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clash Royale</title>
    <link rel="stylesheet" href="/static/home-style.css">
   <style>
/* Mobile responsive fixes */
@media (max-width: 768px) {
    body {
        overflow-x: hidden;
    }
    
    .container {
        padding: 10px;
        max-width: 100%;
    }
    
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 1000;
    }
    
    .auth-card {
        max-width: 95%;
        margin: 10px auto;
        padding: 16px;
    }
    
    .leaderboard-section {
        padding: 10px;
    }
    
    .leaderboard-table {
        font-size: 13px;
    }
    
    .game-mode-card {
        min-height: auto;
        padding: 16px;
    }
    #logo{
      min-width: 350px;
    }
    .btn{
      margin: 100px;
    }

    #actionbutton{
      margin: 0 20px 0 20px;
      gap: 12px;
      top: 70px;

    }
    #arenaimg{
     width: 330px;
     margin-bottom: -120px;
     margin-right:-50px;
    }

    #socialContainer{
      margin-top: -70px;
    }
}
/* Social panel & form styles (inline theme) */
.social-container {
  display: none;
  width: 100%;
  padding: 14px;
  box-sizing: border-box;
  min-height: 300px;
  color: #fff;
  z-index: 10;
}

.auth-card {
  width: 100%;
  max-width: 420px;
  margin: 14px auto;
  padding: 18px;
  border-radius: 14px;
  background: linear-gradient(180deg, rgba(10,10,10,0.98), rgba(25,25,25,0.95));
  box-shadow: 0 10px 30px rgba(0,0,0,0.6);
  border: 1px solid rgba(255,215,0,0.06);
}

.auth-tabs {
  display:flex;
  gap:8px;
  margin-bottom:12px;
  justify-content:center;
}

.auth-tab {
  padding:8px 14px;
  border-radius:10px;
  cursor:pointer;
  font-weight:700;
  color:#ccc;
  background:transparent;
  border:1px solid rgba(255,255,255,0.03);
}
.auth-tab.active {
  color:#5a3a00;
  background: linear-gradient(135deg,#ffd700,#ffb300);
  box-shadow: 0 6px 14px rgba(255,183,0,0.08);
  transform: translateY(-2px);
}

.auth-input {
  width:100%;
  padding:10px 12px;
  border-radius:10px;
  margin-bottom:10px;
  background: rgba(255,255,255,0.02);
  border: 2px solid rgba(255,255,255,0.04);
  color:#fff;
  font-weight:600;
  outline:none;
}

.auth-btn {
  width:100%;
  padding:10px;
  border-radius:12px;
  border:none;
  font-weight:800;
  cursor:pointer;
  margin-top:6px;
}

.auth-btn.primary {
  background: linear-gradient(135deg,#ffd700,#ffb300);
  color:#5a3a00;
  border:3px solid #ff9800;
}

.auth-btn.secondary {
  background: linear-gradient(135deg,#00bfff,#0080ff);
  color:#fff;
  border:3px solid #0066cc;
}


.profile-card {
  max-width:420px;
  margin:10px auto;
  padding:16px;
  border-radius:12px;
  background: linear-gradient(180deg, rgba(8,8,8,0.95), rgba(18,18,18,0.95));
  border:1px solid rgba(255,215,0,0.05);
  text-align:center;
}

.profile-name {
  font-size:20px;
  color:#ffd700;
  margin-bottom:6px;
}

.profile-email {
  color:#aaa;
  font-size:13px;
  margin-bottom:8px;
}

.small-meta {
  color:#bbb;
  font-size:12px;
  margin-top:8px;
}

/* Room list cards */
.room-card {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:10px 12px;
  border-radius:10px;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border: 1px solid rgba(255,255,255,0.03);
  color: #fff;
}

.room-card .meta {
  display:flex;
  align-items:center;
  gap:10px;
  font-size:13px;
  color:#ddd;
}

.room-code {
  font-weight:800;
  color:#ffd700;
  letter-spacing:1px;
  font-size:16px;
}

.room-owner {
  color:#aaa;
  font-size:13px;
}

.room-join-btn {
  padding:8px 12px;
  border-radius:10px;
  border:none;
  font-weight:700;
  cursor:pointer;
}
.room-join-btn.small {
  padding:6px 10px;
  font-size:13px;
}


/* helper notice */
.auth-note {
  color:#ffb3b3;
  font-size:13px;
  text-align:center;
  margin-top:8px;
}

/* responsive tweaks */
@media (max-width:480px) {
  .auth-card { padding:12px; }
  #logo { width: 260px; margin-left: 30px; }
}
</style>

</head>
<body>
    <div class="game-container">
        
        <div class="gradient-bg"></div>
        <div class="stars" id="stars"></div>
       

       
            <img src="https://raw.githubusercontent.com/smlbiobot/cr/master/fan_kit/logo/ClashRoyale_logo_version_02.png" alt="trophy" id="logo" class="trophy-icon" >
       

            <!-- Arena Display -->
            <div class="arena-container" id="arenaContainer">
                
                    <img src="/static/assets/home-page/arena-0.png" alt="arena" class="arena-image" id ="arenaimg">
                    <div class="arena-label">
                        <span>Trainer Camp</span>
                    
                </div>
            </div>

            <!-- Deck Cards Display (Hidden by default) -->
            <div class="deck-container" id="deckContainer" style="display: none;">
                <div class="deck-cards-grid">
                    <div class="deck-card">
                        <div class="card-image">
                            <img src="static/assets/pekka-p.png" alt="pekka">
                        </div>
                        <div class="card-name">P.E.K.K.A</div>
                        <div class="card-stats">
                            <div class="stat-item">
                                <span class="stat-label">Power:</span>
                                <span class="stat-value">3</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Speed:</span>
                                <span class="stat-value">2.3</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Elixir:</span>
                                <span class="stat-value">5</span>
                            </div>
                        </div>
                    </div>

                    <div class="deck-card">
                        <div class="card-image">
                            <img src="static/assets/valk-p.png" alt="valkyrie">
                        </div>
                        <div class="card-name">Valkyrie</div>
                        <div class="card-stats">
                            <div class="stat-item">
                                <span class="stat-label">Power:</span>
                                <span class="stat-value">1.3</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Speed:</span>
                                <span class="stat-value">5</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Elixir:</span>
                                <span class="stat-value">3</span>
                            </div>
                        </div>
                    </div>

                    <div class="deck-card">
                        <div class="card-image">
                            <img src="static/assets/knight-p.png" alt="knight">
                        </div>
                        <div class="card-name">Knight</div>
                        <div class="card-stats">
                            <div class="stat-item">
                                <span class="stat-label">Power:</span>
                                <span class="stat-value">1</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Speed:</span>
                                <span class="stat-value">3</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Elixir:</span>
                                <span class="stat-value">3</span>
                            </div>
                        </div>
                    </div>

                    <div class="deck-card">
                        <div class="card-image">
                            <img src="static/assets/giant-p.png" alt="royal giant">
                        </div>
                        <div class="card-name">Royal Giant</div>
                        <div class="card-stats">
                            <div class="stat-item">
                                <span class="stat-label">Power:</span>
                                <span class="stat-value">3</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Speed:</span>
                                <span class="stat-value">1.5</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Elixir:</span>
                                <span class="stat-value">5</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons " id="actionbutton">
                <button class="battle-btn" onclick="window.location.href='/ball'">
                    <span>Play from both sides</span>
                </button>
                <button class="party-btn" onclick="window.location.href='/ai'">
                    <span>play with bot
                    </span>
                </button>
               <button class="party-btn" id="openRoomModal" type="button" style="cursor:pointer;">
                <span>play Online (room)</span>
                </button>
                
            </div>

            <!-- Card Deck Preview
            <div class="deck-preview">
                <div class="deck-cards">
                    <div class="card-slot">
                        <img src="assets/knight-p.png" alt="knight">
                    </div>
                    <div class="card-slot">
                        <img src="assets/valk-p.png" alt="valkyrie">
                    </div>
                    <div class="card-slot">
                        <img src="assets/pekka-p.png" alt="pekka">
                    </div>
                    <div class="card-slot">
                        <img src="assets/giant-p.png" alt="giant">
                    </div>
                    <div class="card-slot empty"></div>
                </div>
            </div>
        </div> -->

        <!-- SOCIAL SECTION (paste after deck-container) -->
<div class="social-container" id="socialContainer" aria-live="polite">

  <!-- Auth card (login / register) -->
  <div class="auth-card" id="authCard">
    <div class="auth-tabs" role="tablist">
      <div class="auth-tab active" id="tabLogin">Login</div>
      <div class="auth-tab" id="tabRegister">Register</div>
    </div>

    <!-- Login form -->
    <form id="loginForm" style="display:block;">
      <input class="auth-input" id="loginUsername" placeholder="Username" required />
      <input class="auth-input" id="loginPassword" placeholder="Password" type="password" required />
      <div style="display:flex;gap:10px;">
        <button type="button" id="loginBtn" class="auth-btn primary chota">Log In</button>
        <button type="button" id="showRegisterBtn" class="auth-btn secondary chota">Go to Register</button>
      </div>
      <div id="loginError" class="auth-note" style="display:none;"></div>
    </form>

    <!-- Register form -->
    <form id="registerForm" style="display:none;">
      <input class="auth-input" id="regUsername" placeholder="Choose username" required />
      <input class="auth-input" id="regEmail" placeholder="Email address" type="email" required />
      <input class="auth-input" id="regPassword" placeholder="Choose a password" type="password" required />
      <div style="display:flex;gap:10px;">
        <button type="button" id="registerBtn" class="auth-btn primary">Create Account</button>
        <button type="button" id="showLoginBtn" class="auth-btn secondary">Back to Login</button>
      </div>
      <div id="registerError" class="auth-note" style="display:none;"></div>
    </form>
  </div>

  <!-- Profile card (shown when logged in) -->
  <div id="profileCard" class="profile-card" style="display:none;">
    <div class="profile-name" id="profileUsername">USERNAME</div>
    <div class="profile-email" id="profileEmail">email@example.com</div>
    <div class="small-meta" id="profileMeta">Member since: —</div>
    
    <!-- Stats Section -->
    <div style="display:flex; gap:12px; margin:16px 0; justify-content:center; flex-wrap:wrap;">
      <div style="flex:1; min-width:100px; background:linear-gradient(135deg, rgba(255,215,0,0.15), rgba(255,165,0,0.1)); 
                  border-radius:12px; padding:12px; text-align:center; border:2px solid rgba(255,215,0,0.3);">
        <!-- <div style="font-size:28px; margin-bottom:4px;">🏆</div> -->
        <div style="font-size:22px; font-weight:bold; color:#ffd700;" id="userTrophies">0</div>
        <div style="font-size:11px; color:#aaa; text-transform:uppercase; letter-spacing:0.5px;">Trophies</div>
      </div>
      
      <div style="flex:1; min-width:100px; background:linear-gradient(135deg, rgba(76,175,80,0.15), rgba(56,142,60,0.1)); 
                  border-radius:12px; padding:12px; text-align:center; border:2px solid rgba(76,175,80,0.3);">
        <!-- <div style="font-size:28px; margin-bottom:4px;">✅</div> -->
        <div style="font-size:22px; font-weight:bold; color:#4caf50;" id="userWins">0</div>
        <div style="font-size:11px; color:#aaa; text-transform:uppercase; letter-spacing:0.5px;">Wins</div>
      </div>
      
      <div style="flex:1; min-width:100px; background:linear-gradient(135deg, rgba(33,150,243,0.15), rgba(25,118,210,0.1)); 
                  border-radius:12px; padding:12px; text-align:center; border:2px solid rgba(33,150,243,0.3);">
        <!-- <div style="font-size:28px; margin-bottom:4px;">⚔️</div> -->
        <div style="font-size:22px; font-weight:bold; color:#2196f3;" id="userMatches">0</div>
        <div style="font-size:11px; color:#aaa; text-transform:uppercase; letter-spacing:0.5px;">Matches</div>
      </div>
    </div>
    
    <div style="display:flex;gap:10px;justify-content:center;margin-top:12px;">
      <button id="logoutBtn" class="auth-btn secondary">Logout</button>
      <button id="editProfileBtn" class="auth-btn primary">Edit</button>
    </div>
  </div>



<!-- Leaderboard Section (visible to all) -->
<div id="leaderboardSection" style="max-width:900px; margin:20px auto; padding:20px; 
     background:linear-gradient(180deg, rgba(10,10,10,0.95), rgba(20,20,20,0.95)); 
     border-radius:16px; box-shadow:0 8px 32px rgba(0,0,0,0.5);">
  
  <h2 style="color:#ffd700; text-align:center; margin:0 0 20px 0; font-size:22px; 
             text-shadow:0 0 20px rgba(255,215,0,0.5);">
    🏆 Global Leaderboard
  </h2>
  
  <div style="overflow-x:auto;">
    <table style="width:100%; border-collapse:collapse; color:#fff;">
      <thead>
        <tr style="background:rgba(255,215,0,0.1); border-bottom:2px solid rgba(255,215,0,0.3);">
          <th style="padding:12px; text-align:left; font-size:14px; color:#ffd700;">Rank</th>
          <th style="padding:12px; text-align:left; font-size:14px; color:#ffd700;">Player</th>
          <th style="padding:12px; text-align:center; font-size:14px; color:#ffd700;">Trophies</th>
          <th style="padding:12px; text-align:center; font-size:14px; color:#ffd700;">Wins</th>
          <th style="padding:12px; text-align:center; font-size:14px; color:#ffd700;">Matches</th>
        </tr>
      </thead>
      <tbody id="leaderboardBody">
        <tr>
          <td colspan="5" style="padding:40px; text-align:center; color:#888;">
            Loading leaderboard...
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <!-- Pagination (page buttons 1 & 2) -->
  <div id="leaderboardPagination" style="display:flex; justify-content:center; align-items:center; 
       gap:12px; margin-top:20px; flex-wrap:wrap;">
    <div id="pageButtons" style="display:flex; gap:8px;"></div>
    <span id="pageInfo" style="color:#aaa; font-size:14px; min-width:90px; text-align:center;">Page 1</span>
  </div>
</div>

</div>


        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="nav-item">
                <div class="nav-icon">
                    <img src="static/assets/home-page/cards-icon.png" alt="cards">
                </div>
                <span>Cards</span>
            </button>
            <button class="nav-item active">
                <div class="nav-icon">
                    <img src="static/assets/home-page/sword.png" alt="battle">
                </div>
                <span>Battle</span>
            </button>
            <button class="nav-item">
                <div class="nav-icon">
                    <img src="https://raw.githubusercontent.com/smlbiobot/cr/master/ui/leagues/league-champion-grand.png" alt="social">
                </div>
                <span>Social</span>
            </button>
        </div>
    </div>

  <!-- REPLACE the entire existing roomModal DIV with this upgraded modal -->
<div id="roomModal" style="display:none; position:fixed; inset:0; z-index:99999; 
    background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); align-items:center; justify-content:center;">
  <div role="dialog" aria-modal="true" aria-labelledby="roomTitle"
       style="width:92%; max-width:620px; border-radius:14px; padding:18px; 
              background: linear-gradient(180deg, rgba(10,10,10,0.98), rgba(20,20,20,0.98)); 
              box-shadow: 0 12px 40px rgba(0,0,0,0.7); position:relative; margin:auto;">
    
    <button id="closeRoomModal" aria-label="Close" type="button"
            style="position:absolute; right:12px; top:12px; background:transparent; border:none; color:#fff; 
                   font-size:20px; cursor:pointer;">✕</button>

    <h3 id="roomTitle" style="color:#ffd700; margin:0 0 6px 0; font-size:20px; text-align:center;">
      Play Online — Room
    </h3>

    <p style="color:#ccc; font-size:13px; text-align:center; margin:0 0 12px 0;">
      Join an existing room or create a new one. Toggle Create / Join to reveal the correct inputs.
    </p>

    <!-- top controls: toggle Create vs Join -->
    <div style="display:flex; gap:8px; justify-content:center; margin-bottom:12px;">
      <!-- <button id="modalCreateTab" class="auth-btn primary" style="min-width:120px; font-weight:700;">
        Create Room
      </button> -->
      <button id="modalJoinTab" class="auth-btn secondary" style="min-width:120px; font-weight:700;">
        Have a room code?
      </button>
    </div>

    <!-- Form (keeps the original form for Create to work server-side). We'll handle Join via AJAX -->
    <form id="roomForm" action="/" method="POST" style="display:flex; gap:12px; flex-direction:column;">
      <input name="name" id="roomName" type="text" placeholder="Your name" required
             style="width:100%; padding:10px 12px; border-radius:10px; border:2px solid rgba(255,215,0,0.12); 
                    background:rgba(255,255,255,0.03); color:#fff; outline:none; font-weight:600; display:none;" />

      <!-- Room code field: hidden on Create, visible for Join -->
      <input name="code" id="roomCode" type="text" placeholder="Room code (for join)" maxlength="8" 
             style="width:100%; padding:10px 12px; border-radius:10px; border:2px solid rgba(255,255,255,0.06);
                    background:rgba(255,255,255,0.02); color:#fff; font-weight:600; display:none;" />

      <!-- hidden flags kept for backward compatibility when using form submit to create -->
      <input type="hidden" name="join" id="roomJoin" value="">
     <!-- JOIN MODE ELEMENTS -->
<div id="joinSection" style="display:none; flex-direction:column; gap:10px;">
  <input type="hidden" name="create" id="roomCreate" value="">
  <button id="joinRoomBtn" type="button" 
          style="flex:1; padding:10px 12px; border-radius:12px; border:2px solid #0066cc; 
                 background:linear-gradient(135deg,#00bfff,#0080ff); color:#fff; font-weight:700; cursor:pointer;">
    Join
  </button>
</div>

      <div id="roomError" style="display:none; color:#ff8a8a; font-size:13px; text-align:center;"></div>
      <h3  style="display:flex; align-items: center; justify-content: center; color: #ffd700; font-size: 14px;">OR</h3>
      <!-- Buttons row -->
      <div style="display:flex; gap:10px; margin-top:4px;">
        <!-- Create: will submit existing form to server (keeps existing behavior) -->
        <button id="createRoomBtn" type="button" 
                style="flex:1; padding:10px 12px; border-radius:12px; border:2px solid #ff9800; 
                       background:linear-gradient(135deg,#ffd700,#ffb300); color:#5a3a00; font-weight:700; cursor:pointer;">
          Create Room(auto code)
        </button>

        <!-- Join: will use AJAX endpoint /api/room/join -->
       
      </div>
    </form>

    <!-- Divider -->
    <hr style="border:none; height:1px; background:rgba(255,255,255,0.03); margin:14px 0;">
    <h4  style="display:flex; align-items: center; justify-content: center; color: #ffd700; font-size: 14px;">Public rooms are visible below </h4>
     <p style="color:#999; font-size:12px; margin:8px 0 20px 0; text-align:center;">
      click Join to jump right in. Private rooms won't show here.
    </p>
    <!-- Scrollable public rooms list -->
    <div style="max-height:260px; overflow:auto; padding-right:6px;" id="roomListContainer" aria-live="polite">
      <div id="roomList" style="display:flex; flex-direction:column; gap:10px; padding:4px 0;">
        <!-- populated dynamically -->
        <div style="color:#aaa; padding:18px; text-align:center;">Loading public rooms...</div>
      </div>
    </div>

   
  </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", function() {
  const createBtn = document.getElementById("createRoomBtn");
  const joinBtn = document.getElementById("joinRoomBtn");
  const roomCodeWrapper = document.getElementById("roomCodeWrapper");
  const publicList = document.getElementById("publicRoomsList");

  // --- Toggle join mode ---
  joinBtn.addEventListener("click", () => {
    const name = document.getElementById("playerName").value.trim();
    const code = document.getElementById("roomCode").value.trim().toUpperCase();
    if (!code) {
      roomCodeWrapper.style.display = "block";
      roomCodeWrapper.querySelector("input").focus();
      return;
    }
    window.location.href = `/?join=1&name=${encodeURIComponent(name)}&code=${code}`;
  });

  createBtn.addEventListener("click", () => {
    const name = document.getElementById("playerName").value.trim();
    if (!name) return alert("Please enter your name");
    window.location.href = `/?create=1&name=${encodeURIComponent(name)}`;
  });

  // --- Load Public Rooms ---
  async function loadPublicRooms() {
    try {
      const res = await fetch("/api/rooms/public");
      const data = await res.json();
      if (!data.ok || data.rooms.length === 0) {
        publicList.innerHTML = `<p class="text-center text-muted small mb-0">No public rooms available</p>`;
        return;
      }

      publicList.innerHTML = "";
      data.rooms.forEach(room => {
        const el = document.createElement("div");
        el.className = "d-flex justify-content-between align-items-center bg-dark rounded-3 p-2 mb-2 room-item";
        el.style.cursor = "pointer";
        el.innerHTML = `
          <div>
            <strong>${room.code}</strong>
            <span class="text-muted small"> (${room.members}/2 players)</span>
          </div>
          <span class="badge bg-success">${room.is_private ? "Private" : "Public"}</span>
        `;
        el.addEventListener("click", () => {
          document.getElementById("roomCode").value = room.code;
          roomCodeWrapper.style.display = "block";
          roomCodeWrapper.scrollIntoView({ behavior: "smooth" });
        });
        publicList.appendChild(el);
      });
    } catch (err) {
      publicList.innerHTML = `<p class="text-danger text-center small">Failed to load rooms</p>`;
    }
  }

  loadPublicRooms();
});


/* ---------- Unified client script for index.html ---------- */

/* ---------- 1) Stars background ---------- */
(function createStars() {
  const starsContainer = document.getElementById('stars');
  if (!starsContainer) return;
  if (starsContainer.children.length === 0) {
    for (let i = 0; i < 150; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      star.style.left = `${Math.random() * 100}%`;
      star.style.top = `${Math.random() * 100}%`;
      star.style.animation = `twinkle ${2 + Math.random() * 3}s infinite ${Math.random() * 2}s`;
      starsContainer.appendChild(star);
    }
  }
})();

/* ---------- Utility: safe element getter ---------- */
function $id(id) { return document.getElementById(id); }

/* ---------- Helper: panel switching (Deck / Arena / Social) ---------- */
function showPanel(panel) {
  const arenaContainer = $id('arenaContainer');
  const deckContainer = $id('deckContainer');
  const socialContainer = $id('socialContainer');

  if (arenaContainer) arenaContainer.style.display = 'none';
  if (deckContainer) deckContainer.style.display = 'none';
  if (socialContainer) socialContainer.style.display = 'none';

  if (panel === 'arena' && arenaContainer) arenaContainer.style.display = 'flex';
  if (panel === 'deck' && deckContainer) deckContainer.style.display = 'block';
  if (panel === 'social' && socialContainer) socialContainer.style.display = 'block';

  const logo = $id('logo');
  if (logo) logo.style.display = (panel === 'social') ? 'none' : '';
}

/* ---------- Auth helpers (server-backed) ---------- */
async function apiGetJson(url) {
  const res = await fetch(url, { credentials: 'same-origin' });
  return res.json().catch(()=>({ ok: false }));
}
async function apiPostForm(url, dataObj) {
  const body = new URLSearchParams(dataObj);
  const res = await fetch(url, { method: 'POST', body, credentials: 'same-origin' });
  return res.json().catch(()=>({ ok: false }));
}

async function checkAuth() {
  try {
    const json = await apiGetJson('/api/auth');
    return json.ok ? json.user : null;
  } catch (e) { return null; }
}

/* ---------- Room modal helpers ---------- */
function openModal(modal) {
  if (!modal) return;
  modal.style.display = 'flex';
  modal.style.alignItems = 'center';
  modal.style.justifyContent = 'center';
}
function closeModal(modal) {
  if (!modal) return;
  modal.style.display = 'none';
}

/* ---------- DOM ready: wire everything once ---------- */
document.addEventListener('DOMContentLoaded', () => {
  /* ----- element refs ----- */
  const navItems = Array.from(document.querySelectorAll('.nav-item'));
  const actionbutton = $id('actionbutton');
  const tabLogin = $id('tabLogin');
  const tabRegister = $id('tabRegister');
  const loginForm = $id('loginForm');
  const registerForm = $id('registerForm');
  const loginError = $id('loginError');
  const registerError = $id('registerError');
  const profileCard = $id('profileCard');
  const profileUsername = $id('profileUsername');
  const profileEmail = $id('profileEmail');
  const profileMeta = $id('profileMeta');
  const logoutBtn = $id('logoutBtn');
  const editProfileBtn = $id('editProfileBtn');
  const openRoomModalBtn = $id('openRoomModal');
  const roomModal = $id('roomModal');
  const closeRoomModal = $id('closeRoomModal');
  const roomForm = $id('roomForm');
  const roomNameInput = $id('roomName');
  const roomCodeInput = $id('roomCode');
  const roomJoinHidden = $id('roomJoin');
  const roomCreateHidden = $id('roomCreate');
  const createRoomBtn = $id('createRoomBtn');
  const joinRoomBtn = $id('joinRoomBtn');
  const roomError = $id('roomError');
  const loginUsername = $id('loginUsername');
  const loginPassword = $id('loginPassword');
  const regUsername = $id('regUsername');
  const regEmail = $id('regEmail');
  const regPassword = $id('regPassword');
  const registerBtn = $id('registerBtn');
  const loginBtn = $id('loginBtn');
  const showRegisterBtn = $id('showRegisterBtn');
  const showLoginBtn = $id('showLoginBtn');

  /* ----- nav click behavior ----- */
  if (navItems.length) {
    navItems.forEach((item, index) => {
      item.addEventListener('click', function () {
        navItems.forEach(n => n.classList.remove('active'));
        this.classList.add('active');
        if (index === 0) {
          showPanel('deck');
          if (actionbutton) actionbutton.style.display = 'none';
        } else if (index === 1) {
          showPanel('arena');
          if (actionbutton) actionbutton.style.display = '';
        } else {
          showPanel('social');
          if (actionbutton) actionbutton.style.display = 'none';
          renderSocial(); // refresh auth UI when opening social tab
        }
      });
    });
  }

  /* ----- tab switching (login/register) ----- */
  if (tabLogin && tabRegister && loginForm && registerForm) {
    tabLogin.addEventListener('click', () => {
      tabLogin.classList.add('active'); tabRegister.classList.remove('active');
      loginForm.style.display = 'block'; registerForm.style.display = 'none';
    });
    tabRegister.addEventListener('click', () => {
      tabRegister.classList.add('active'); tabLogin.classList.remove('active');
      registerForm.style.display = 'block'; loginForm.style.display = 'none';
    });
    if (showRegisterBtn) showRegisterBtn.addEventListener('click', () => tabRegister.click());
    if (showLoginBtn) showLoginBtn.addEventListener('click', () => tabLogin.click());
  }

  /* ----- render social UI based on server auth ----- */
  async function renderSocial() {
    const auth = await checkAuth();
    if (auth) {
      if (profileCard) profileCard.style.display = 'block';
      if ($id('authCard')) $id('authCard').style.display = 'none';
      if (profileUsername) profileUsername.textContent = auth.username || 'Player';
      if (profileEmail) profileEmail.textContent = auth.email || '—';
      if (profileMeta) profileMeta.textContent = 'Member since: ' + new Date(auth.created_at).toLocaleDateString();
      
      // Update stats
      if ($id('userTrophies')) $id('userTrophies').textContent = auth.trophies || 0;
      if ($id('userWins')) $id('userWins').textContent = auth.match_wins || 0;
      if ($id('userMatches')) $id('userMatches').textContent = auth.total_matches || 0;
      
      enableRoomAccess(true);
    } else {
      if (profileCard) profileCard.style.display = 'none';
      if ($id('authCard')) $id('authCard').style.display = 'block';
      if (tabLogin) tabLogin.click();
      enableRoomAccess(false);
    }
    
    // Load leaderboard (visible to all)
    loadLeaderboard(1);
  }
  
  /* ----- Leaderboard functionality ----- */
  let currentPage = 1;
  let totalPages = 1;
  
  async function loadLeaderboard(page) {
    currentPage = page;
    const response = await fetch(`/api/leaderboard?page=${page}`);
    const data = await response.json();
    
    if (!data.ok) {
      if ($id('leaderboardBody')) {
        $id('leaderboardBody').innerHTML = '<tr><td colspan="5" style="padding:40px; text-align:center; color:#f88;">Failed to load leaderboard</td></tr>';
      }
      return;
    }
    
    totalPages = data.total_pages || 1;
    const leaderboard = data.leaderboard || [];
    
    // Update table
    const tbody = $id('leaderboardBody');
    if (!tbody) return;
    
    if (leaderboard.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="padding:40px; text-align:center; color:#888;">No players yet. Be the first!</td></tr>';
    } else {
      tbody.innerHTML = leaderboard.map((player, idx) => {
        const rankBadge = player.rank === 1 ? '🥇' : player.rank === 2 ? '🥈' : player.rank === 3 ? '🥉' : player.rank;
        const rowStyle = player.rank <= 3 ? 'background:rgba(255,215,0,0.05);' : '';
        return `
          <tr style="${rowStyle} border-bottom:1px solid rgba(255,255,255,0.05);">
            <td style="padding:12px; font-weight:bold; color:#ffd700;">${rankBadge}</td>
            <td style="padding:12px; font-weight:600;">${player.username}</td>
            <td style="padding:12px; text-align:center; color:#ffd700;">${player.trophies}</td>
            <td style="padding:12px; text-align:center; color:#4caf50;">${player.match_wins}</td>
            <td style="padding:12px; text-align:center; color:#2196f3;">${player.total_matches}</td>
          </tr>
        `;
      }).join('');
    }
    
    // Update pagination UI
    if ($id('pageInfo')) $id('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
    // Render page buttons (1..2 and possibly … last)
    renderPageButtons();
  }
  
  // ---------- Page buttons pagination (1 & 2) ----------
  // Renders buttons for pages 1..min(totalPages, 2) and wires clicks to loadLeaderboard
  function renderPageButtons() {
    const container = $id('pageButtons');
    if (!container) return;
    container.innerHTML = '';

    const maxButtons = Math.min(2, totalPages || 1);
    for (let p = 1; p <= maxButtons; p++) {
      const btn = document.createElement('button');
      btn.className = 'auth-btn secondary page-btn';
      btn.textContent = String(p);
      btn.dataset.page = String(p);
      btn.style.minWidth = '40px';
      btn.style.padding = '8px 10px';
      btn.style.fontWeight = '800';

      if (p === currentPage) {
        btn.classList.add('active');
        btn.style.background = 'linear-gradient(135deg,#ffd700,#ffb300)';
        btn.style.color = '#5a3a00';
        btn.style.border = '3px solid #ff9800';
        btn.style.transform = 'translateY(-2px)';
      }

      btn.addEventListener('click', () => {
        const page = Number(btn.dataset.page);
        if (page === currentPage) return;
        loadLeaderboard(page);
      });

      container.appendChild(btn);
    }

    if ((totalPages || 1) > 2) {
      const dots = document.createElement('div');
      dots.textContent = '…';
      dots.style.color = '#aaa';
      dots.style.alignSelf = 'center';
      dots.style.padding = '0 6px';
      container.appendChild(dots);

      const lastBtn = document.createElement('button');
      lastBtn.className = 'auth-btn secondary page-btn';
      lastBtn.textContent = String(totalPages);
      lastBtn.dataset.page = String(totalPages);
      lastBtn.style.minWidth = '44px';
      lastBtn.addEventListener('click', () => {
        const last = Number(lastBtn.dataset.page);
        if (last === currentPage) return;
        loadLeaderboard(last);
      });
      container.appendChild(lastBtn);
    }
  }

  /* ----- enable/disable room button ----- */
  function enableRoomAccess(enabled) {
    if (!openRoomModalBtn) return;
    openRoomModalBtn.disabled = !enabled;
    openRoomModalBtn.style.cursor = enabled ? 'pointer' : 'not-allowed';
    openRoomModalBtn.style.opacity = enabled ? '1' : '0.7';
    openRoomModalBtn.title = enabled ? 'Open room modal' : 'Login required to create/join rooms';
  }

  /* ----- register/login/logout handlers (server API) ----- */
  if (registerBtn) {
    registerBtn.addEventListener('click', async () => {
      if (!registerError) return;
      registerError.style.display = 'none';
      const u = (regUsername && regUsername.value || '').trim();
      const e = (regEmail && regEmail.value || '').trim();
      const p = (regPassword && regPassword.value || '');

      if (!u || !e || !p) {
        registerError.style.display = 'block'; registerError.textContent = 'Please fill all fields.'; return;
      }
      if (!/^[a-zA-Z0-9_]{3,20}$/.test(u)) {
        registerError.style.display = 'block'; registerError.textContent = 'Username: 3-20 chars (letters, numbers, _)'; return;
      }
      if (!/^[^@]+@[^@]+\.[^@]+$/.test(e)) {
        registerError.style.display = 'block'; registerError.textContent = 'Enter a valid email address.'; return;
      }
      if (p.length < 5) {
        registerError.style.display = 'block'; registerError.textContent = 'Password should be at least 5 characters.'; return;
      }

      const json = await apiPostForm('/api/register', { username: u, email: e, password: p });
      if (json.ok) {
        registerError.style.display = 'block';
        registerError.style.color = '#aef2b1';
        registerError.textContent = 'Account created & logged in!';
        await renderSocial();
      } else {
        registerError.style.display = 'block';
        registerError.style.color = '#ffb3b3';
        registerError.textContent = json.error || 'Registration failed';
      }
    });
  }

  if (loginBtn) {
    loginBtn.addEventListener('click', async () => {
      if (!loginError) return;
      loginError.style.display = 'none';
      const u = (loginUsername && loginUsername.value || '').trim();
      const p = (loginPassword && loginPassword.value || '');
      if (!u || !p) {
        loginError.style.display = 'block'; loginError.textContent = 'Enter username and password.'; return;
      }
      const json = await apiPostForm('/api/login', { username: u, password: p });
      if (json.ok) {
        await renderSocial();
        loginError.style.display = 'block';
        loginError.style.color = '#aef2b1';
        loginError.textContent = 'Logged in!';
      } else {
        loginError.style.display = 'block';
        loginError.style.color = '#ffb3b3';
        loginError.textContent = json.error || 'Login failed';
      }
    });
  }

  if (logoutBtn) {
    logoutBtn.addEventListener('click', async () => {
      await fetch('/api/logout', { method: 'POST', credentials: 'same-origin' });
      await renderSocial();
    });
  }

  if (editProfileBtn) {
    editProfileBtn.addEventListener('click', async () => {
      // simple inline email edit that calls api - for demo we only update UI locally
      const auth = await checkAuth();
      if (!auth) return alert('Not logged in.');
      const newEmail = prompt('Update email:', auth.email || '');
      if (!newEmail) return;
      if (!/^[^@]+@[^@]+\.[^@]+$/.test(newEmail)) return alert('Invalid email.');
      // NOTE: server API to update email not implemented; we just refresh UI here
      // You can add /api/update-profile to persist changes server-side.
      alert('Email updated locally (to persist implement server API).');
      // refresh UI values (best-effort)
      if (profileEmail) profileEmail.textContent = newEmail;
    });
  }

  /* ----- Room modal: open/close + create/join ----- */
  /* ----- Room modal: open/close + create/join (REPLACEMENT) ----- */
if (openRoomModalBtn) {
  openRoomModalBtn.addEventListener('click', async (ev) => {
    const auth = await checkAuth();
    if (!auth) {
      // switch to social tab and show login prompt
      navItems.forEach(nav => nav.classList.remove('active'));
      const socialNav = navItems[2];
      if (socialNav) socialNav.classList.add('active');
      showPanel('social');
      await renderSocial();
      if (loginError) {
        loginError.style.display = 'block';
        loginError.style.color = '#ffb3b3';
        loginError.textContent = 'Please login or register to create/join rooms.';
      }
      return;
    }

    // prefill display name
    if (roomNameInput) roomNameInput.value = auth.username || '';

    // open modal and load public rooms
    if (roomModal) {
      roomError && (roomError.style.display = 'none');
      roomCodeInput && (roomCodeInput.value = '');
      openModal(roomModal);
      fetchAndRenderRooms();
      // default to Create tab selected
      selectRoomTab('create');
    }
  });
}

if (closeRoomModal) closeRoomModal.addEventListener('click', () => closeModal(roomModal));
if (roomModal) {
  roomModal.addEventListener('click', (ev) => {
    if (ev.target === roomModal) closeModal(roomModal);
  });
}
window.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') closeModal(roomModal); });

/* tab controls */
const modalCreateTab = $id('modalCreateTab');
const modalJoinTab = $id('modalJoinTab');

function selectRoomTab(mode) {
  // mode: 'create' or 'join'
  if (mode === 'create') {
    modalCreateTab && modalCreateTab.classList.add('active');
    modalJoinTab && modalJoinTab.classList.remove('active');
    if (roomCodeInput) roomCodeInput.style.display = 'none';
    if (joinSection) joinSection.style.display = 'none';
    if (roomCreateHidden) roomCreateHidden.value = '1';
    if (roomJoinHidden) roomJoinHidden.value = '';
  } else {
    modalJoinTab && modalJoinTab.classList.add('active');
    modalCreateTab && modalCreateTab.classList.remove('active');
    if (roomCodeInput) roomCodeInput.style.display = '';
    if (joinSection) joinSection.style.display = 'flex'; 
    if (roomCreateHidden) roomCreateHidden.value = '';
    if (roomJoinHidden) roomJoinHidden.value = '1';
  }
}

if (modalCreateTab) modalCreateTab.addEventListener('click', () => selectRoomTab('create'));
if (modalJoinTab) modalJoinTab.addEventListener('click', () => selectRoomTab('join'));

/* Create - use existing form submit path (server will create room and redirect to /room) */
if (createRoomBtn) {
  createRoomBtn.addEventListener('click', (ev) => {
    ev.preventDefault();
    const name = (roomNameInput && roomNameInput.value || '').trim();
    if (!name) {
      if (roomError) { roomError.style.display = 'block'; roomError.textContent = 'Enter your display name.'; }
      return;
    }
    // mark create and submit the form (legacy server flow)
    if (roomCreateHidden) roomCreateHidden.value = '1';
    if (roomJoinHidden) roomJoinHidden.value = '';
    roomForm.submit();
  });
}

/* Join via AJAX */
if (joinRoomBtn) {
  joinRoomBtn.addEventListener('click', async (ev) => {
    ev.preventDefault();
    if (!roomForm) return;
    const name = (roomNameInput && roomNameInput.value || '').trim();
    const code = (roomCodeInput && roomCodeInput.value || '').trim().toUpperCase();

    if (!name) {
      if (roomError) { roomError.style.display = 'block'; roomError.textContent = 'Enter your display name.'; }
      return;
    }
    if (!code) {
      if (roomError) { roomError.style.display = 'block'; roomError.textContent = 'Enter room code to join.'; }
      return;
    }

    roomError && (roomError.style.display = 'none');

    // Call AJAX join endpoint to validate + set session server-side
    try {
      const res = await fetch('/api/room/join', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ code, name })
      });
      const json = await res.json();
      if (!json.ok) {
        roomError.style.display = 'block';
        roomError.textContent = json.error || 'Failed to join room';
        return;
      }
      // success -> redirect (server returned url)
      window.location = json.redirect || '/room';
    } catch (e) {
      roomError.style.display = 'block';
      roomError.textContent = 'Network error joining room.';
    }
  });
}

/* Fetch public rooms list and render them */
async function fetchAndRenderRooms() {
  const listEl = $id('roomList');
  if (!listEl) return;
  listEl.innerHTML = '<div style="color:#aaa; padding:18px; text-align:center;">Loading public rooms...</div>';
  try {
    const res = await fetch('/api/rooms', { credentials: 'same-origin' });
    const data = await res.json();
    if (!data.ok) {
      listEl.innerHTML = '<div style="color:#f88; padding:18px; text-align:center;">Failed to load rooms.</div>';
      return;
    }
    renderRoomsList(data.rooms || []);
  } catch (err) {
    listEl.innerHTML = '<div style="color:#f88; padding:18px; text-align:center;">Network error loading rooms.</div>';
  }
}

function renderRoomsList(rooms) {
  const listEl = $id('roomList');
  if (!listEl) return;
  if (!rooms || rooms.length === 0) {
    listEl.innerHTML = '<div style="color:#aaa; padding:18px; text-align:center;">No public rooms yet.</div>';
    return;
  }

  listEl.innerHTML = ''; // clear
  rooms.forEach(r => {
    const card = document.createElement('div');
    card.className = 'room-card';
    card.innerHTML = `
      <div style="display:flex; align-items:center; gap:12px;">
        <div class="room-code">${r.code}</div>
        <div class="meta">
          <div class="room-owner">Owner: ${r.owner_username}</div>
          <div style="color:#9ecbff; font-weight:700;">${r.members}/${r.max_members}</div>
        </div>
      </div>
      <div style="display:flex; align-items:center; gap:8px;">
        <button class="room-join-btn small" data-code="${r.code}">Join</button>
      </div>
    `;
    listEl.appendChild(card);
  });

  // wire join buttons
  Array.from(listEl.querySelectorAll('.room-join-btn')).forEach(btn => {
    btn.addEventListener('click', async (ev) => {
      const code = btn.getAttribute('data-code');
      const name = (roomNameInput && roomNameInput.value || '').trim();
      if (!name) {
        if (roomError) { roomError.style.display = 'block'; roomError.textContent = 'Enter your display name.'; }
        return;
      }
      // call same join API (AJAX)
      try {
        const res = await fetch('/api/room/join', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ code, name })
        });
        const json = await res.json();
        if (!json.ok) {
          roomError.style.display = 'block';
          roomError.textContent = json.error || 'Failed to join room';
          return;
        }
        window.location = json.redirect || '/room';
      } catch (e) {
        roomError.style.display = 'block';
        roomError.textContent = 'Network error joining room.';
      }
    });
  });
}


  /* ----- initial UI render ----- */
  renderSocial();
});
</script>


</body>
</html>
